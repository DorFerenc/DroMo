<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dromo - 3D Model Generation</title>
    <!-- Include Axios library for making HTTP requests -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.156.1/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.156.1/examples/jsm/"
        }
    }
    </script>
    <style>
        /* Base styles for the body */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Styling for the main heading */
        h1 {
            color: #2c3e50;
        }

        /* Styling for each section of the page */
        .section {
            margin-bottom: 30px;
        }

        /* Styles for input fields */
        input[type="text"], input[type="file"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }

        /* Base styles for buttons */
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            margin-right: 5px;
        }

        /* Hover effect for buttons */
        button:hover {
            background-color: #2980b9;
        }

        /* Specific styles for delete buttons */
        button.delete {
            background-color: #e74c3c;
        }

        button.delete:hover {
            background-color: #c0392b;
        }

        /* Styles for the video list */
        #videoList, #pointCloudList, #modelList {
            list-style-type: none;
            padding: 0;
        }

        /* Styles for each item in the lists */
        #videoList li, #pointCloudList li, #modelList li {
            background-color: #f9f9f9;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Styles for the details sections */
        #videoDetails, #pointCloudDetails, #modelDetails {
            background-color: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }

        /* Styles for tabs */
        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #ccc;
        }

        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

        #modelViewer {
            width: 100%;
            height: 400px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Dromo - 3D Model Generation</h1>

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'VideoTab')" id="defaultOpen">Videos</button>
        <button class="tablinks" onclick="openTab(event, 'PointCloudTab')">Point Clouds</button>
        <button class="tablinks" onclick="openTab(event, 'ModelTab')">3D Models</button>
    </div>

    <!-- Section for uploading a new video -->
    <div id="VideoTab" class="tabcontent">
        <div class="section">
            <h2>Upload Video</h2>
            <input type="text" id="videoTitle" placeholder="Video Title">
            <input type="file" id="videoFile" accept="video/*">
            <button onclick="uploadVideo()">Upload</button>
        </div>

        <!-- Section for displaying the list of videos -->
        <div class="section">
            <h2>Video List</h2>
            <button onclick="listVideos()">Refresh Video List</button>
            <ul id="videoList"></ul>
        </div>

        <!-- Section for displaying details of a selected video -->
        <div class="section">
            <h2>Video Details</h2>
            <div id="videoDetails"></div>
        </div>
    </div>

    <!-- Section for uploading a new point cloud -->
    <div id="PointCloudTab" class="tabcontent">
        <div class="section">
            <h2>Upload Point Cloud</h2>
            <input type="text" id="pointCloudName" placeholder="Point Cloud Name">
            <input type="file" id="pointCloudFile" accept=".txt,.csv">
            <button onclick="uploadPointCloud()">Upload</button>
        </div>

        <div class="section">
            <h2>Point Cloud List</h2>
            <button onclick="listPointClouds()">Refresh Point Cloud List</button>
            <ul id="pointCloudList"></ul>
        </div>

        <div class="section">
            <h2>Point Cloud Details</h2>
            <div id="pointCloudDetails"></div>
        </div>
    </div>

    <!-- New 3D Model Tab -->
    <div id="ModelTab" class="tabcontent">
        <div class="section">
            <h2>3D Model List</h2>
            <button onclick="listModels()">Refresh 3D Model List</button>
            <ul id="modelList"></ul>
        </div>

        <div class="section">
            <h2>3D Model Details</h2>
            <div id="modelDetails"></div>
        </div>

        <div class="section">
            <h2>3D Model Visualization</h2>
            <div id="modelViewer"></div>
        </div>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Open the default tab
        document.addEventListener('DOMContentLoaded', (event) => {
            document.getElementById("defaultOpen").click();
        });
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { MTLLoader } from 'three/addons/loaders/MTLLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Base URL for API requests
        const API_URL = 'http://localhost:5000/api';

        /**
         * Uploads a video to the server
         */
        async function uploadVideo() {
            const title = document.getElementById('videoTitle').value;
            const file = document.getElementById('videoFile').files[0];

            if (!title || !file) {
                alert('Please provide both title and file');
                return;
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('file', file);

            try {
                const response = await axios.post(`${API_URL}/upload`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                alert('Video uploaded successfully!');
                listVideos();
            } catch (error) {
                console.error('Error uploading video:', error);
                let errorMessage = 'Error uploading video';
                if (error.response && error.response.data && error.response.data.error) {
                    errorMessage = error.response.data.error;
                }
                alert(errorMessage);
            }
        }

        /**
         * Fetches the list of videos from the server and updates the UI
         */
        async function listVideos() {
            try {
                const response = await axios.get(`${API_URL}/videos`);
                const videoList = document.getElementById('videoList');
                videoList.innerHTML = '';
                response.data.forEach(video => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${video.title}</span>
                        <div>
                            <button onclick="getVideoDetails('${video.id}')">Details</button>
                            <button class="delete" onclick="deleteVideo('${video.id}')">Delete</button>
                        </div>
                    `;
                    videoList.appendChild(li);
                });
            } catch (error) {
                console.error('Error listing videos:', error);
                alert('Error listing videos');
            }
        }

        /**
         * Fetches and displays details for a specific video
         */
        async function getVideoDetails(id) {
            try {
                const response = await axios.get(`${API_URL}/videos/${id}`);
                const videoDetails = document.getElementById('videoDetails');
                videoDetails.innerHTML = `
                    <h3>${response.data.title}</h3>
                    <p>ID: ${response.data.id}</p>
                    <p>File Path: ${response.data.file_path}</p>
                    <p>Timestamp: ${response.data.timestamp}</p>
                `;
            } catch (error) {
                console.error('Error getting video details:', error);
                alert('Error getting video details');
            }
        }

        /**
         * Deletes a video from the server
         */
        async function deleteVideo(id) {
            if (confirm('Are you sure you want to delete this video?')) {
                try {
                    await axios.delete(`${API_URL}/videos/${id}`);
                    alert('Video deleted successfully');
                    listVideos();
                } catch (error) {
                    console.error('Error deleting video:', error);
                    alert('Error deleting video');
                }
            }
        }

        /**
         * Uploads a point cloud to the server
         */
        async function uploadPointCloud() {
            const name = document.getElementById('pointCloudName').value;
            const file = document.getElementById('pointCloudFile').files[0];

            if (!name || !file) {
                alert('Please provide both name and file');
                return;
            }

            const formData = new FormData();
            formData.append('name', name);
            formData.append('file', file);

            try {
                const response = await axios.post(`${API_URL}/point_clouds`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                });
                alert('Point cloud uploaded successfully!');
                listPointClouds();
            } catch (error) {
                console.error('Error uploading point cloud:', error);
                let errorMessage = 'Error uploading point cloud';
                if (error.response && error.response.data && error.response.data.error) {
                    errorMessage = error.response.data.error;
                }
                alert(errorMessage);
            }
        }

        /**
         * Starts the reconstruction process for a point cloud
         */
        async function reconstructPointCloud(pointCloudId) {
            try {
                const response = await axios.post(`${API_URL}/reconstruct/${pointCloudId}`);
                alert(`Reconstruction started. Model ID: ${response.data.model_id}`);
            } catch (error) {
                console.error('Error starting reconstruction:', error);
                alert('Error starting reconstruction');
            }
        }

        /**
         * Fetches the list of point clouds from the server and updates the UI
         */
        async function listPointClouds() {
            try {
                const response = await axios.get(`${API_URL}/point_clouds`);
                const pointCloudList = document.getElementById('pointCloudList');
                pointCloudList.innerHTML = '';
                response.data.forEach(pc => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>${pc.name}</span>
                        <div>
                            <button onclick="getPointCloudDetails('${pc.id}')">Details</button>
                            <button class="delete" onclick="deletePointCloud('${pc.id}')">Delete</button>
                            <button onclick="reconstructPointCloud('${pc.id}')">Reconstruct</button>
                        </div>
                    `;
                    pointCloudList.appendChild(li);
                });
            } catch (error) {
                console.error('Error listing point clouds:', error);
                alert('Error listing point clouds');
            }
        }

        /**
         * Fetches and displays details for a specific point cloud
         */
        async function getPointCloudDetails(id) {
            try {
                const response = await axios.get(`${API_URL}/point_clouds/${id}`);
                const pointCloudDetails = document.getElementById('pointCloudDetails');
                pointCloudDetails.innerHTML = `
                    <h3>${response.data.name}</h3>
                    <p>ID: ${response.data.id}</p>
                    <p>Number of Points: ${response.data.num_points}</p>
                    <p>Has Colors: ${response.data.has_colors}</p>
                    <p>Timestamp: ${response.data.timestamp}</p>
                `;
            } catch (error) {
                console.error('Error getting point cloud details:', error);
                alert('Error getting point cloud details');
            }
        }

        /**
         * Deletes a point cloud from the server
         */
        async function deletePointCloud(id) {
            if (confirm('Are you sure you want to delete this point cloud?')) {
                try {
                    await axios.delete(`${API_URL}/point_clouds/${id}`);
                    alert('Point cloud deleted successfully');
                    listPointClouds();
                } catch (error) {
                    console.error('Error deleting point cloud:', error);
                    alert('Error deleting point cloud');
                }
            }
        }

        /**
         * Fetches the list of 3D models from the server and updates the UI
         */
        async function listModels() {
            try {
                const response = await axios.get(`${API_URL}/models`);
                const modelList = document.getElementById('modelList');
                modelList.innerHTML = '';
                response.data.forEach(model => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span>Model ID: ${model.id}</span>
                        <div>
                            <button onclick="getModelDetails('${model.id}')">Details</button>
                            <button onclick="visualizeModel('${model.id}')">Visualize</button>
                            <button onclick="downloadModel('${model.id}')">Download OBJ</button>
                            <button onclick="downloadTexture('${model.id}')">Download Texture</button>
                            <button onclick="downloadMaterial('${model.id}')">Download Material</button>
                            <button class="delete" onclick="deleteModel('${model.id}')">Delete</button>
                        </div>
                    `;
                    modelList.appendChild(li);
                });
            } catch (error) {
                console.error('Error listing 3D models:', error);
                alert('Error listing 3D models');
            }
        }

        /**
         * Fetches and displays details for a specific 3D model
         */
        async function getModelDetails(id) {
            try {
                const response = await axios.get(`${API_URL}/models/${id}`);
                const modelDetails = document.getElementById('modelDetails');
                modelDetails.innerHTML = `
                    <h3>${response.data.name}</h3>
                    <p>ID: ${response.data.id}</p>
                    <p>Location: ${response.data.folder_path}</p>
                    <p>Point Cloud ID: ${response.data.point_cloud_id}</p>
                    <p>OBJ File: ${response.data.obj_file}</p>
                    <p>MTL File: ${response.data.mtl_file}</p>
                    <p>Texture File: ${response.data.texture_file}</p>
                    <p>Created At: ${response.data.created_at}</p>
                `;
                console.log('Model details:', response.data);
            } catch (error) {
                console.error('Error getting 3D model details:', error);
                alert('Error getting 3D model details');
            }
        }

        /**
         * Deletes a 3D model from the server
         */
        async function deleteModel(id) {
            if (confirm('Are you sure you want to delete this 3D model?')) {
                try {
                    await axios.delete(`${API_URL}/models/${id}`);
                    alert('3D model deleted successfully');
                    listModels();
                } catch (error) {
                    console.error('Error deleting 3D model:', error);
                    alert('Error deleting 3D model');
                }
            }
        }

        /**
         * Initiates download of the OBJ file for a 3D model
         */
        function downloadModel(id) {
            window.location.href = `${API_URL}/models/${id}/download`;
        }

        /**
         * Initiates download of the texture file for a 3D model
         */
        function downloadTexture(id) {
            window.location.href = `${API_URL}/models/${id}/texture`;
        }

        /**
         * Initiates download of the material file for a 3D model
         */
        function downloadMaterial(id) {
            window.location.href = `${API_URL}/models/${id}/material`;
        }

        let currentModelViewer = null;

        /**
         * Visualizes a 3D model
         */
        async function visualizeModel(modelId) {
            console.log('Visualizing model:', modelId);
            try {
                const modelDetails = await axios.get(`${API_URL}/models/${modelId}`);
                console.log('Model details for visualization:', modelDetails.data);
                const { obj_file, mtl_file, texture_file } = modelDetails.data;

                // Clear the existing viewer container
                const viewerContainer = document.getElementById('modelViewer');
                viewerContainer.innerHTML = '';

                // Dispose of the previous viewer if it exists
                if (currentModelViewer) {
                    console.log('Clearing previous model viewer');
                    currentModelViewer.dispose();
                    // currentModelViewer.clear();
                }

                console.log('Creating new ModelViewer');
                currentModelViewer = new ModelViewer('modelViewer');
                console.log('Loading model into viewer');
                await currentModelViewer.loadModel(modelId, obj_file, mtl_file, texture_file);
                console.log('Model loaded successfully');
            } catch (error) {
                console.error('Error visualizing 3D model:', error);
                if (error.response) {
                    console.error('Response data:', error.response.data);
                    console.error('Response status:', error.response.status);
                }
                alert('Error visualizing 3D model: ' + error.message);
            }
        }

        /**
         * Class for handling 3D model visualization
         */
        class ModelViewer {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                this.scene = new THREE.Scene();
                this.camera = new THREE.PerspectiveCamera(75, this.container.clientWidth / this.container.clientHeight, 0.1, 1000);
                this.renderer = new THREE.WebGLRenderer();
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
                this.container.appendChild(this.renderer.domElement);

                this.camera.position.z = 5;

                this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.25;
                this.controls.screenSpacePanning = false;
                this.controls.maxPolarAngle = Math.PI / 2;

                // Add ambient light
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                this.scene.add(ambientLight);

                // Add directional light
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(0, 1, 0);
                this.scene.add(directionalLight);

                this.animate = this.animate.bind(this);
                this.animationFrameId = null;
                this.animate();

                console.log('ModelViewer initialized');
            }

            async loadModel(modelId, objFile, mtlFile, textureFile) {
                console.log('Loading model:', { modelId, objFile, mtlFile, textureFile });
                const mtlLoader = new MTLLoader();
                const objLoader = new OBJLoader();

                try {
                    console.log('Loading MTL file:', `${API_URL}/models/${modelId}/material`);
                    const materials = await mtlLoader.loadAsync(`${API_URL}/models/${modelId}/material`);
                    materials.preload();
                    objLoader.setMaterials(materials);

                    console.log('Loading OBJ file:', `${API_URL}/models/${modelId}/obj`);
                    const object = await objLoader.loadAsync(`${API_URL}/models/${modelId}/obj`);

                    // Center the object
                    console.log('Model loaded, centering object');
                    const box = new THREE.Box3().setFromObject(object);
                    const center = box.getCenter(new THREE.Vector3());
                    object.position.sub(center);

                    this.scene.add(object);
                    console.log('Object added to scene');

                    // Adjust camera to fit the object
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const fov = this.camera.fov * (Math.PI / 180);
                    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                    this.camera.position.z = cameraZ * 1.5; // Add some padding

                    this.controls.update();
                    console.log('Camera and controls updated');
                } catch (error) {
                    console.error('Error loading 3D model:', error);
                    alert('Error loading 3D model');
                }
            }

            animate() {
                // requestAnimationFrame(this.animate);
                this.animationFrameId = requestAnimationFrame(this.animate);
                this.controls.update();
                this.renderer.render(this.scene, this.camera);
            }

            // clear() {
            //     while(this.scene.children.length > 0) {
            //         this.scene.remove(this.scene.children[0]);
            //     }
            //     console.log('Scene cleared');
            // }

            dispose() {
                console.log('Disposing ModelViewer');
                // Stop the animation loop
                if (this.animationFrameId) {
                    cancelAnimationFrame(this.animationFrameId);
                }

                // Dispose of Three.js objects
                this.scene.traverse((object) => {
                    if (object.geometry) {
                        object.geometry.dispose();
                    }
                    if (object.material) {
                        if (Array.isArray(object.material)) {
                            object.material.forEach(material => material.dispose());
                        } else {
                            object.material.dispose();
                        }
                    }
                });

                // Dispose of the renderer
                this.renderer.dispose();

                // Remove the canvas element from the DOM
                if (this.renderer.domElement && this.renderer.domElement.parentNode) {
                    this.renderer.domElement.parentNode.removeChild(this.renderer.domElement);
                }

                // Dispose of the controls
                this.controls.dispose();

                console.log('ModelViewer disposed');
            }
        }

        // Make functions available globally
        window.uploadVideo = uploadVideo;
        window.listVideos = listVideos;
        window.getVideoDetails = getVideoDetails;
        window.deleteVideo = deleteVideo;
        window.uploadPointCloud = uploadPointCloud;
        window.reconstructPointCloud = reconstructPointCloud;
        window.listPointClouds = listPointClouds;
        window.getPointCloudDetails = getPointCloudDetails;
        window.deletePointCloud = deletePointCloud;
        window.listModels = listModels;
        window.getModelDetails = getModelDetails;
        window.deleteModel = deleteModel;
        window.downloadModel = downloadModel;
        window.downloadTexture = downloadTexture;
        window.downloadMaterial = downloadMaterial;
        window.visualizeModel = visualizeModel;

        // Initialize the page
        listVideos();
        listPointClouds();
        listModels();
    </script>
</body>
</html>